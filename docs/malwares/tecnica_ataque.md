# Seção: Técnicas de Exploração de Malware

> **Objetivo da seção:** explicar as técnicas modernas que malware usa para penetrar, persistir, mover-se e ocultar-se em sistemas — com ênfase em como isso se aplica a redes corporativas e ambientes de controle/automação.

---

## 1. O que é uma técnica de exploração de malware
- **Definição:** método específico pelo qual código malicioso consegue **infiltrar-se** e **infectar** um sistema alvo.  
- Evolução histórica:
  - *Antes:* malware baseado em arquivo (executáveis, macros) que ativam quando o arquivo é aberto.  
  - *Hoje:* crescimento do **fileless malware** que executa código diretamente na memória, deixando poucos vestígios em disco.

---

## 2. Modelo de implantação moderno (fluxo em estágios)
- A maioria dos ataques segue um **modelo em múltiplos estágios**:
  1. **Estágio 1 — Dropper / Downloader / Shellcode (inicial):**
     - *Dropper:* peça leve cujo trabalho é iniciar outros componentes maliciosos no host.  
     - *Downloader:* baixa ferramentas/payloads adicionais da Internet.  
     - *Shellcode:* trecho compacto de código (por ex., em um exploit) que executa uma rotina de carga inicial.
  2. **Estágio 2 — Payload principal (ex.: RAT, backdoor, ransomware):**
     - Depois do estágio 1, o estágio 2 fornece persistência, C2 (comando e controle) e funcionalidades maliciosas.
  3. **Fase de Ação sobre o Objetivo:** exfiltração, criptografia (ransomware), sabotagem, movimento lateral.
  4. **Fase de Ocultação:** apagar rastros, limpar logs, técnicas de persistência e camuflagem.

*Exemplo em automação:* um técnico abre um arquivo de manutenção (dropper) que baixa um agente que cria um backdoor na estação de engenharia, permitindo alterações remotas em projetos de PLC.

---

## 3. Fileless malware e execução em memória
- **Fileless:** código é executado como script (PowerShell, WMI, MSHTA, Bash) ou como shellcode na memória, minimizando artefatos em disco.  
- Vantagem para o atacante: evita detecção por antivírus baseados em assinatura.  
- Pode gravar artefatos temporários que são removidos após a execução — dificultando investigação forense.

---

## 4. Técnicas de entrega e implantação (com exemplos)
- **Injeção de código:** injeta-se código malicioso no espaço de processos legítimos para que pareçam processos confiáveis.  
- **Process Hollowing (esvaziamento de processo):** cria-se um processo legítimo suspenso, substitui-se seu código por malware e o retoma, mantendo a aparência legítima.  
- **DLL Injection:** força um processo a carregar uma DLL maliciosa que executa código no contexto do processo.  
- **DLL Sideloading:** coloca-se uma DLL maliciosa em um local onde um aplicativo legítimo carregará automaticamente essa DLL vulnerável.  
- **Mascaramento / Ofuscação / Criptografia:** compactar/obfuscar payloads para impedir análise estática.  
- **Uso de exploits / shellcodes:** explorar vulnerabilidades para executar código sem interação do usuário.  
- **Entrega via mídia removível, phishing, atualizações comprometidas, canais de fornecedor.**

*Exemplo OT:* um utilitário legítimo de atualização de firmware espera uma DLL em seu diretório; um atacante coloca uma DLL maliciosa (sideload) e ganha execução com privilégios do utilitário.

---

## 5. Living-off-the-land (LOL) / ferramentas legítimas usadas maliciosamente
- **Conceito:** invasores abusam de ferramentas já presentes no sistema (PowerShell, WMI, PsExec, CertUtil, PowerSploit, ferramentas de vendor) para executar ações maliciosas.  
- Vantagem: as ações parecem “normais” e são mais difíceis de distinguir do comportamento legítimo.  
- Mitigações específicas: habilitar logging avançado (PowerShell Script Block Logging, AMSI), restringir execução de scripts, application whitelisting.

---

## 6. Estratégias antiforense e persistência
- **Apagar/alterar logs**, limpar evidências e timestamps.  
- **Rootkits** ou técnicas kernel-mode para esconder processos/arquivos.  
- **Múltiplos pontos de persistência:** serviços, tarefas agendadas, entradas de inicialização, drivers assinados/mal assinados.  
- **Canais C2 redundantes** e uso de protocolos legítimos/HTTPS para disfarçar comunicação.

---

## 7. Técnicas de detecção e investigação
- **EDR (Endpoint Detection & Response):** monitoramento de comportamento, execução em memória e técnicas de resposta.  
- **Sysmon / logging enriquecido:** registrar criação de processos, carregamento de DLLs, conexões de rede, hashes de executáveis.  
- **Monitoramento de tráfego de saída (egress):** identificar comunicações C2 e downloads suspeitos.  
- **Script block / PowerShell logging & AMSI:** capturar scripts em memória e bloquear payloads ofuscados.  
- **Análise de memória (memory forensics):** identificar shellcode e payloads residentes na memória.  
- **Alertas baseados em IOC e comportamento (execução de comandos remotos fora do padrão).**

---

## 8. Boas práticas de mitigação (foco corporativo e OT)
- **Patching e gestão de vulnerabilidades:** priorizar correções de superfícies expostas (servidores, HMIs, gateways).  
- **Segmentação de rede:** separar IT/OT; controlar e restringir acesso de estações de engenharia.  
- **Least privilege:** evitar contas administrativas permanentes; usar contas com privilégios temporários.  
- **Application Control / Whitelisting:** permitir execução somente de software aprovado.  
- **Desabilitar/mitigar ferramentas desnecessárias:** restringir PowerShell, WMI, PsExec onde não são essenciais.  
- **EDR/IDS/Network monitoring:** visibilidade de processos anômalos e tráfego inusitado.  
- **Políticas de mídia removível:** bloquear ou escanear USBs; usar mecanismos de leitura segura.  
- **Procedimentos de resposta a incidente:** playbooks para isolamento, coleta de memória e análise.

*Exemplo prático:* bloquear execução de scripts PowerShell em estações de operadores e usar uma jump box para atividades de engenharia com monitoramento EDR.

---

## 9. Resumo / Takeaways
- Técnicas de exploração evoluíram de arquivos estacionários para **ataques sem arquivo**, execução em memória e uso de ferramentas legítimas.  
- Ataques modernos normalmente são **multifásicos** (dropper → downloader → payload → ação → ocultação).  
- Mitigar requer uma combinação de: **patching**, **segmentação**, **controle de execução**, **monitoramento comportamental** e práticas de resposta.  
- Em ambientes de automação, cuide especialmente de **estações de engenharia, atualizações de firmware e políticas de mídia removível**, porque são vetores práticos e perigosos.

---

### Glossário rápido
- **Dropper:** programa leve que inicia payloads extras.  
- **Downloader:** componente que baixa ferramentas/payloads adicionais.  
- **Shellcode:** pequeno código de ataque executado diretamente na memória.  
- **Fileless malware:** execução na memória sem artefatos persistentes no disco.  
- **Process Hollowing / Esvaziamento de processo:** substituir código legítimo de um processo por malware.  
- **DLL Sideloading / Injeção de DLL:** técnicas para executar código malicioso no contexto de processos legítimos.  
- **Living-off-the-land (LOL):** uso de ferramentas legítimas do sistema para ações maliciosas.

---

> Fique atento: conhecer essas técnicas permite projetar defesas defensivas mais eficazes — especialmente em redes mistas IT/OT onde a disponibilidade e integridade dos sistemas são críticas.
